<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>carDetails</title>
    <link
            rel="stylesheet"
            href="/carDetailsAssets/bootstrap/css/bootstrap.min.css"
    />
    <link
            rel="stylesheet"
            href="/carDetailsAssets/css/bs-theme-overrides.css"
    />
    <link rel="stylesheet" href="/carDetailsAssets/css/animate.min.css"/>
    <link
            rel="stylesheet"
            href="/carDetailsAssets/css/Lightbox-Gallery-No-Gutters-baguetteBox.min.css"
    />
    <link
            rel="stylesheet"
            href="/carDetailsAssets/css/Navbar-Right-Links-Dark-icons.css"
    />
</head>

<body
        style="
			width: 100%;
			filter: brightness(100%);
			text-align: center;
			border-top-right-radius: 6px;
			border-top-left-radius: 6px;
			border-bottom-right-radius: 6px;
			border-bottom-left-radius: 6px;
		"
>
<nav
        class="navbar navbar-expand-md py-3"
        style="
				--bs-body-bg: rgb(109, 24, 106);
				background: var(--bs-white);
				border-bottom-color: var(--bs-danger-border-subtle);
				box-shadow: 8px -6px 20px, 0px 0px 12px var(--bs-border-color);
				width: 100%;
			"
>
    <div class="container">
        <a
                class="navbar-brand d-flex align-items-center"
                href="/admin/dashboard"
                style="color: var(--bs-success-text-emphasis)"
        ><span
                    class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon"
            ><svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                        class="bi bi-bezier"
                        data-bss-hover-animate="jello"
                >
							<path
                                    fill-rule="evenodd"
                                    d="M0 10.5A1.5 1.5 0 0 1 1.5 9h1A1.5 1.5 0 0 1 4 10.5v1A1.5 1.5 0 0 1 2.5 13h-1A1.5 1.5 0 0 1 0 11.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm10.5.5A1.5 1.5 0 0 1 13.5 9h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1a1.5 1.5 0 0 1-1.5-1.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM6 4.5A1.5 1.5 0 0 1 7.5 3h1A1.5 1.5 0 0 1 10 4.5v1A1.5 1.5 0 0 1 8.5 7h-1A1.5 1.5 0 0 1 6 5.5zM7.5 4a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"
                            ></path>
							<path
                                    d="M6 4.5H1.866a1 1 0 1 0 0 1h2.668A6.517 6.517 0 0 0 1.814 9H2.5c.123 0 .244.015.358.043a5.517 5.517 0 0 1 3.185-3.185A1.503 1.503 0 0 1 6 5.5zm3.957 1.358A1.5 1.5 0 0 0 10 5.5v-1h4.134a1 1 0 1 1 0 1h-2.668a6.517 6.517 0 0 1 2.72 3.5H13.5c-.123 0-.243.015-.358.043a5.517 5.517 0 0 0-3.185-3.185z"
                            ></path></svg></span
            ><span
                    data-bss-hover-animate="pulse"
                    style="font-size: 20px; text-align: center"
            >IUT Traffic Record Management System</span
            ></a
        >
        <button
                data-bs-toggle="collapse"
                class="navbar-toggler"
                data-bs-target="#navcol-2"
        >
					<span class="visually-hidden">Toggle navigation</span
                    ><span class="navbar-toggler-icon"></span>
        </button>
        <div
                class="collapse navbar-collapse"
                id="navcol-2"
                style="margin-right: -77px"
        >
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a
                            class="nav-link active"
                            data-bss-hover-animate="pulse"
                            id="view_logs"
                            href="/<%= appUser.designation === "User" ? "" : "admin/"; %>dashboard"
                            style="
									padding-left: 52px;
									--bs-body-font-size: -14rem;
									font-size: 20px;
									text-shadow: 0px 0px 1px;
									color: var(--bs-emphasis-color);
								"
                    ><span style="color: rgb(10, 54, 34)"
                        >Dashboard</span
                        ></a
                    >
                </li>
                <% if (appUser.designation !== "User") { %>
                    <li class="nav-item">
                        <a
                                class="nav-link active"
                                data-bss-hover-animate="pulse"
                                id="view_logs"
                                href="/admin/view-vehicle-logs"
                                style="
									padding-left: 52px;
									--bs-body-font-size: -14rem;
									font-size: 20px;
									text-shadow: 0px 0px 1px;
									color: var(--bs-emphasis-color);
								"
                        ><span style="color: rgb(10, 54, 34)"
                            >View Logs</span
                            ></a
                        >
                    </li>
                    <% if (appUser.designation === "SCO") { %>
                        <li class="nav-item">
                            <a
                                    class="nav-link"
                                    data-bss-hover-animate="pulse"
                                    id="pending_request"
                                    href="/admin/get-approval"
                                    style="
									padding-left: 52px;
									--bs-body-font-size: -14rem;
									font-size: 20px;
									text-shadow: 0px 0px 1px;
									color: var(--bs-emphasis-color);
								"
                            ><span style="color: rgb(10, 54, 34)"
                                >Pending Request</span
                                ></a
                            >
                        </li>
                    <% } %>
                <% } %>
                <li class="nav-item">
                    <a
                            class="nav-link"
                            data-bss-hover-animate="pulse"
                            id="logout"
                            href="/logout"
                            style="
									padding-left: 52px;
									--bs-body-font-size: -14rem;
									font-size: 20px;
									text-shadow: 0px 0px 1px;
									color: var(--bs-emphasis-color);
								"
                    ><span style="color: rgb(10, 54, 34)"
                        >Logout</span
                        ></a
                    >
                </li>
                <li class="nav-item">
                    <a
                            class="nav-link"
                            data-bss-hover-animate="pulse"
                            id="logout"
                            href="#"
                            style="
									padding-left: 52px;
									--bs-body-font-size: -14rem;
									font-size: 20px;
									text-shadow: 0px 0px 1px;
									color: var(--bs-emphasis-color);
								"
                    ><span style="color: rgb(10, 54, 34)"
                        ><%= appUser.name; %>(<%= appUser.designation %>)</span
                        ></a
                    >
                </li>
            </ul>
        </div>
    </div>
</nav>

<% for (const err of error) { %>
    <div class="alert alert-danger" role="alert"
         style="margin-top: 2%;margin-left: 25%;margin-right: 25%;width: 50%;display: flex;justify-content: space-between;">
        <strong><%= err; %></strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>
<% for (const message of success) { %>
    <div class="alert alert-success" role="alert"
         style="margin-top: 2%;margin-left: 25%;margin-right: 25%;width: 50%;display: flex;justify-content: space-between;">
        <strong><%= message; %></strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div
        class="flex-column"
        style="
				width: 40%;
				border-color: var(--bs-primary-border-subtle);
				margin-left: 30%;
				background: var(--bs-body-bg);
				height: initial;
				margin-top: 2%;
				border-radius: 11px;
				box-shadow: 0px 0px 4px;
				opacity: 1;
			"
>


    <div class="input-group">
				<span
                        class="input-group-text"
                        style="width: 29%; border-radius: 12px 0px 0px 0px"
                >License number :</span
                ><input
                class="form-control"
                type="text"
                id="licenseNumber"
                readonly=""
                style="
						border-radius: 0px;
						border-top-left-radius: 0px;
						border-top-right-radius: 12px;
					"
                name="licenseNumber"
                value="<%= vehicle.licenseNumber %>"
        />
    </div>
    <div class="input-group">
				<span
                        class="input-group-text"
                        style="
						width: 29%;
						border-radius: 8px 0px 0px 6px;
						border-top-left-radius: 0px;
						border-bottom-left-radius: 0px;
					"
                >Vehicle name :</span
                ><input
                class="form-control"
                type="text"
                id="vehicleName"
                readonly=""
                style="border-radius: 0px"
                name="vehicleName"
                value="<%= vehicle.vehicleName %>"
        />
    </div>
    <% if (appUser.designation !== "User") { %>
        <div class="input-group">
				<span
                        class="input-group-text"
                        style="
						width: 29%;
						border-top-left-radius: 0px;
						border-bottom-left-radius: 0px;
					"
                >Owner ID :</span
                ><a href="/admin/view-user-details/<%= user.id %>"
                    style="color: var(--bs-danger-text-emphasis)">
                <input
                        class="form-control"
                        type="text"
                        id="ownerId"
                        readonly=""
                        style="border-radius: 0px"
                        name="ownerId"
                        value="<%= user.id %>"
                /></a>
        </div>
    <% } %>
    <div class="input-group">
				<span
                        class="input-group-text"
                        style="
						width: 29%;
						border-top-left-radius: 0px;
						border-bottom-left-radius: 0px;
					"
                >Owner name :</span
                ><input
                class="form-control"
                type="text"
                id="ownerName"
                readonly=""
                style="border-radius: 0px"
                name="ownerName"
                value="<%= user.name %>"
        />
    </div>
    <div class="input-group">
				<span
                        class="input-group-text"
                        style="
						width: 29%;
						border-top-left-radius: 0px;
						border-bottom-left-radius: 0px;
					"
                >Contact number :</span
                ><input
                class="form-control"
                type="text"
                id="contactNumber"
                readonly=""
                style="border-radius: 0px"
                name="contactNumber"
                value="<%= user.phoneNumber %>"
        />
    </div>
    <div class="input-group" style="width: 100%">
				<span
                        class="input-group-text"
                        style="
						width: 29%;
						border-top-left-radius: 0px;
						border-bottom-left-radius: 0px;
					"
                >Ban Status :</span
                >
        <div
                class="dropdown show"
                style="
						width: 71.1%;
						background: var(--bs-primary-bg-subtle);
					"
        >
            <button
                    class="btn btn-primary dropdown-toggle rounded-0 rounded-end"
                    aria-expanded="true"
                    data-bs-toggle="dropdown"
                    type="button"
            <% if (appUser.designation === "SCO") { %>
                    onclick="return confirm('Are you sure you want to proceed?');"
                    <% } %>
                    style="
							width: 100%;
							background: var(--bs-tertiary-bg);
							color: var(--bs-primary-text-emphasis);
							border-radius: 0px;
							border-top-right-radius: 0px;
							border-bottom-right-radius: 0px;
						"
            >
                <%= vehicle.defaultDuration === 0 ? "Banned" : "Eligible" %>
            </button>
            <% if (appUser.designation === "SCO") { %>
                <div
                        class="dropdown-menu"
                        data-bs-popper="none"
                        style="border-radius: 0px"
                >
                    <a class="dropdown-item" href="/admin/ban/<%= vehicle.licenseNumber %>">Banned</a
                    ><a class="dropdown-item" href="/admin/unban/<%= vehicle.licenseNumber %>">Eligible</a>
                </div>
            <% } %>
        </div>
    </div>
    <form style="width: 100%" action="/admin/change-duration/<%= vehicle.licenseNumber %>" method="post">
        <div class="input-group">
					<span
                            class="input-group-text"
                            style="width: 29%; border-bottom-left-radius: 12px"
                    >Allowed Duration :</span
                    ><input
                    class="form-control"
                    type="number"
                    id="allowedDuration"
                    name="allowedDuration"
                    required
                    min="0"
                    value="<%= vehicle.defaultDuration %>"
            <% if (appUser.designation !== "SCO") { %>
                    readonly
                    <% } %>
            />
            <% if (appUser.designation === "SCO") { %>
                <button
                        class="btn btn-primary"
                        type="submit"
                        onclick="return confirm('Are you sure you want to proceed?');"
                        style="
							background: var(--bs-btn-border-color);
							width: 9.33%;
							border-top-right-radius: 6px;
						"
                >
                    Edit
                </button>
            <% } %>
        </div>
    </form>
</div>
<form>
    <div
            class="input-group"
            style="width: 35%; margin-left: 32.5%; margin-top: 5%"
    >
        <input
                class="form-control"
                id="time_from"
                type="datetime-local"
                name="time_from"
        /><input
                class="form-control"
                id="time_to"
                type="datetime-local"
                name="time_to"
        />
    </div>
</form>
<div
        class="table-responsive fw-semibold text-start"
        style="
				margin-top: 2%;
				width: 60%;
				margin-right: 10%;
				margin-left: 20%;
				box-shadow: 0px 0px 9px;
				border-radius: 12px;
				height: 40%;
				background: var(--bs-btn-hover-color);
			"
>
    <table hidden>
        <tbody>
        <% for (const log of vehicleLogs) { %>
            <tr>
                <td><%= log.entryTime %></td>
                <td><%= log.exitTime %></td>
                <td><%= log.comment %></td>
                <td><%= Math.floor(log.lateDuration) %></td>
            </tr>
        <% } %>
        </tbody>
    </table>
    <table class="table"></table>
</div>
<script src="/carDetailsAssets/bootstrap/js/bootstrap.min.js"></script>
<script src="/carDetailsAssets/js/bs-init.js"></script>
<script src="/carDetailsAssets/js/Lightbox-Gallery-No-Gutters-baguetteBox.min.js"></script>
<script src="/carDetailsAssets/js/Lightbox-Gallery-No-Gutters-Lightbox-Gallery.js"></script>
<script>
	const vehicleLogs = [];
	document.addEventListener("DOMContentLoaded", () => {
		const table = document.querySelector("table[hidden]");
		for (const row of table.rows) {
			const cell = row.cells;
			vehicleLogs.push({
				entryTime: extractDateTime(cell[0].innerText),
				exitTime: cell[1].innerText,
				comment: cell[2].innerText,
				lateDuration: parseInt(cell[3].innerText),
			});
		}
		console.log(vehicleLogs);
		showResults(vehicleLogs);
	});

	document.querySelector("#time_from").addEventListener("change", (e) => {
		const fromText = e.target.value.length > 0 ? e.target.value : "1970-01-01T00:00";
		const toText = document.querySelector("#time_to").value.length > 0 ? document.querySelector("#time_to").value : "2100-01-01T00:00";
		const timeFrom = new Date(fromText);
		const timeTo = new Date(toText);

		const result = vehicleLogs.filter((log) => {
			return log.entryTime >= timeFrom && log.entryTime <= timeTo;
		});
		showResults(result);
	});

	document.querySelector("#time_to").addEventListener("change", (e) => {
		const toText = e.target.value.length > 0 ? e.target.value : "2100-01-01T00:00";
		const fromText = document.querySelector("#time_from").value.length > 0 ? document.querySelector("#time_from").value : "1970-01-01T00:00";
		const timeFrom = new Date(fromText);
		const timeTo = new Date(toText);

		const result = vehicleLogs.filter((log) => {
			return log.entryTime >= timeFrom && log.entryTime <= timeTo;
		});
		showResults(result);
	});

	/**
	 * Extract date and time from a date time string
	 * @param dateTime - Format: DD/MM/YYYY, HH:MM:SS
	 * @returns Date
	 */
	function extractDateTime(dateTime) {
		const [date, month, year, time] = dateTime.split(/[\/,]/);
		const [hour, minute, second] = time.split(/:/);
		return new Date(year, month - 1, date, hour, minute, second);
	}

	/**
	 * Extract string from date object
	 * @param dateTime - Date object
	 * @returns String
	 */
	function extractStringFromDateTime(dateTime) {
		return dateTime.toLocaleString("en-GB");
	}

	function showResults(logs) {
		const table = document.querySelector("table.table");
		table.innerHTML = `<thead style="width: 80%; padding: 0px">
        <tr style="width: 80%; height: 57.5px">
            <th
                    style="
								box-shadow: 0px 0px 5px 0px;
								border-style: solid;
							"
            >
                Entry time
            </th>
            <th
                    style="
								box-shadow: 0px 0px 5px 0px;
								border-style: solid;
							"
            >
                Exit time
            </th>
            <th style="box-shadow: 0px 0px 5px 0px">Comment</th>
            <th style="box-shadow: 0px 0px 5px 0px">Late Duration</th>
        </tr>
        </thead>
		<tbody style="width: 80%; height: initial">`;

		for (const log of logs) {
			table.innerHTML += `
				<tr
						style="
									margin-right: 19px;
									margin-top: 0px;
									margin-left: -2px;
								"
				>
					<td style="box-shadow: 0px 0px 5px 0px">${extractStringFromDateTime(log.entryTime)}</td>
					<td style="box-shadow: 0px 0px 5px 0px">${log.exitTime}</td>
					<td style="box-shadow: 0px 0px 5px 0px">${log.comment}</td>
					<td style="box-shadow: 0px 0px 5px 0px">${Math.floor(log.lateDuration)}</td>
				</tr>`;
		}

		table.innerHTML += `</tbody>`;
	}
</script>
</body>
</html>
